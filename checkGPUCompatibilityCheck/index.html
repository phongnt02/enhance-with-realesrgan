<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGPU Compatibility Checker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 10px 0;
        }

        button:hover {
            background-color: #45a049;
        }

        .error {
            color: red;
            margin: 10px 0;
        }

        .success {
            color: green;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>WebGPU and TFJS Compatibility Checker</h1>
    <button id="checkButton">Run Compatibility Check</button>
    <div id="status"></div>
    <pre id="results"></pre>

    <!-- Thay đổi cách load TFJS -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
    <!-- Thêm TFJS WebGPU backend -->
    <script
        src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgpu@4.17.0/dist/tf-backend-webgpu.js"></script>

    <!-- Load Compatibility Checker -->
    <script>
        class GPUCompatibilityChecker {
            constructor() {
                this.results = {
                    webgpu: {
                        supported: false,
                        adapter: null,
                        device: null,
                        details: {}
                    },
                    tfjs: {
                        supported: false,
                        version: null,
                        backends: [],
                        webgpuBackend: false
                    },
                    system: {
                        gpu: null,
                        memory: null,
                        platform: null
                    }
                };
            }

            async checkWebGPU() {
                try {
                    // Check if WebGPU is available
                    if (!navigator.gpu) {
                        throw new Error("WebGPU is not supported in this browser");
                    }

                    // Try to get adapter
                    const adapter = await navigator.gpu.requestAdapter();
                    if (!adapter) {
                        throw new Error("Couldn't request WebGPU adapter");
                    }

                    // Get adapter info
                    this.results.webgpu.details = {
                        name: await adapter.requestAdapterInfo().name,
                        vendor: await adapter.requestAdapterInfo().vendor,
                        architecture: await adapter.requestAdapterInfo().architecture
                    };

                    // Try to get device
                    const device = await adapter.requestDevice();
                    if (!device) {
                        throw new Error("Couldn't request WebGPU device");
                    }

                    this.results.webgpu.supported = true;
                    this.results.webgpu.adapter = adapter;
                    this.results.webgpu.device = device;

                    // Get limits and features
                    this.results.webgpu.details.limits = {
                        maxBufferSize: adapter.limits.maxBufferSize,
                        maxComputeWorkgroupsPerDimension: adapter.limits.maxComputeWorkgroupsPerDimension,
                        maxComputeInvocationsPerWorkgroup: adapter.limits.maxComputeInvocationsPerWorkgroup,
                        maxStorageBufferBindingSize: adapter.limits.maxStorageBufferBindingSize
                    };

                } catch (error) {
                    this.results.webgpu.supported = false;
                    this.results.webgpu.error = error.message;
                }
            }

            async checkTFJS() {
                try {
                    // Đợi TFJS initialize
                    await tf.ready();

                    this.results.tfjs.supported = true;
                    this.results.tfjs.version = tf.version.tfjs;

                    // Kiểm tra backends available
                    const backends = Object.keys(tf.engine().registry);
                    this.results.tfjs.backends = backends;

                    // Check WebGPU backend
                    if (backends.includes('webgpu')) {
                        try {
                            await tf.setBackend('webgpu');
                            const backend = tf.getBackend();
                            this.results.tfjs.webgpuBackend = backend === 'webgpu';
                        } catch (e) {
                            this.results.tfjs.webgpuBackend = false;
                            this.results.tfjs.webgpuError = e.message;
                        }
                    }
                } catch (error) {
                    this.results.tfjs.supported = false;
                    this.results.tfjs.error = error.message;
                }
            }

            async checkSystemInfo() {
                // Get GPU info
                if (navigator.gpu) {
                    const adapter = await navigator.gpu.requestAdapter();
                    if (adapter) {
                        const info = await adapter.requestAdapterInfo();
                        this.results.system.gpu = {
                            name: info.name,
                            vendor: info.vendor,
                            architecture: info.architecture
                        };
                    }
                }

                // Get memory info
                if (navigator.deviceMemory) {
                    this.results.system.memory = {
                        deviceMemory: navigator.deviceMemory
                    };
                }

                // Get platform info
                this.results.system.platform = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency
                };
            }

            async checkModelCompatibility(modelUrl) {
                if (!this.results.tfjs.supported || !this.results.tfjs.webgpuBackend) {
                    return false;
                }

                try {
                    // Try to load model
                    const model = await tf.loadGraphModel(modelUrl);

                    // Check if model can run on WebGPU
                    await tf.setBackend('webgpu');

                    // Try a dummy prediction
                    const dummyInput = tf.zeros([1, 3, 64, 64]);
                    await model.predict(dummyInput).data();

                    dummyInput.dispose();
                    model.dispose();

                    return true;
                } catch (error) {
                    console.error("Model compatibility check failed:", error);
                    return false;
                }
            }

            async runAllChecks(modelUrl = null) {
                await this.checkWebGPU();
                await this.checkTFJS();
                await this.checkSystemInfo();

                if (modelUrl) {
                    this.results.modelCompatible = await this.checkModelCompatibility(modelUrl);
                }

                return this.results;
            }

            getDetailedReport() {
                const report = [];

                // WebGPU Support
                report.push("=== WebGPU Support ===");
                report.push(`Supported: ${this.results.webgpu.supported}`);
                if (this.results.webgpu.supported) {
                    report.push(`GPU: ${this.results.webgpu.details.name}`);
                    report.push(`Vendor: ${this.results.webgpu.details.vendor}`);
                    report.push("Limits:");
                    for (const [key, value] of Object.entries(this.results.webgpu.details.limits)) {
                        report.push(`  ${key}: ${value}`);
                    }
                } else {
                    report.push(`Error: ${this.results.webgpu.error}`);
                }

                // TFJS Support
                report.push("\n=== TensorFlow.js Support ===");
                report.push(`Supported: ${this.results.tfjs.supported}`);
                if (this.results.tfjs.supported) {
                    report.push(`Version: ${this.results.tfjs.version}`);
                    report.push(`Available Backends: ${this.results.tfjs.backends.join(', ')}`);
                    report.push(`WebGPU Backend Available: ${this.results.tfjs.webgpuBackend}`);
                } else {
                    report.push(`Error: ${this.results.tfjs.error}`);
                }

                // System Info
                report.push("\n=== System Information ===");
                if (this.results.system.gpu) {
                    report.push(`GPU: ${this.results.system.gpu.name}`);
                    report.push(`GPU Vendor: ${this.results.system.gpu.vendor}`);
                }
                if (this.results.system.memory) {
                    report.push(`Device Memory: ${this.results.system.memory.deviceMemory}GB`);
                }
                report.push(`CPU Threads: ${this.results.system.platform.hardwareConcurrency}`);
                report.push(`Platform: ${this.results.system.platform.platform}`);

                // Model Compatibility
                if ('modelCompatible' in this.results) {
                    report.push("\n=== Model Compatibility ===");
                    report.push(`Model can run on WebGPU: ${this.results.modelCompatible}`);
                }

                return report.join('\n');
            }
        }
    </script>

    <!-- Run the check -->
    <script>
        document.getElementById('checkButton').addEventListener('click', async () => {
            const status = document.getElementById('status');
            const results = document.getElementById('results');

            try {
                status.innerHTML = '<div>Running compatibility checks...</div>';
                // Đợi TFJS load xong
                await tf.ready();

                const checker = new GPUCompatibilityChecker();
                await checker.runAllChecks();

                // Display detailed report
                results.textContent = checker.getDetailedReport();

                // Show summary
                if (checker.results.webgpu.supported && checker.results.tfjs.webgpuBackend) {
                    status.innerHTML = '<div class="success">Your system supports WebGPU acceleration! ✅</div>';
                } else {
                    status.innerHTML = '<div class="error">Your system may not fully support WebGPU acceleration ⚠️</div>';
                }

            } catch (error) {
                status.innerHTML = `<div class="error">Error during compatibility check: ${error.message}</div>`;
                console.error(error);
            }
        });
    </script>
</body>

</html>